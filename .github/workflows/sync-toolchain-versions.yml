name: Sync Toolchain Versions

on:
  pull_request:
    paths:
      - .github/workflows/sync-toolchain.yml
      - flake.lock

jobs:
  sync-toolchain-versions:
    runs-on: ubuntu-24.04
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
      - uses: DeterminateSystems/nix-installer-action@786fff0690178f1234e4e1fe9b536e94f5433196 # v20
      # GitHub Actions側のAPIの変更によりMagic Nix Cacheが使えなくなった
      # 将来的には復活させるか代替案を用意する予定らしいが、現状は未定
      # https://determinate.systems/posts/magic-nix-cache-free-tier-eol/
      # - uses: DeterminateSystems/magic-nix-cache-action@6221693898146dc97e38ad0e013488a16477a4c4 # v9
      - name: Get the Node.js version and update .node-version and renovate.json
        run: |
          NODE_VERSION=$(nix develop --command node --version)
          echo "${NODE_VERSION:1}" > .node-version
          jq "(.packageRules[]
            | select(.matchPackageNames and (.matchPackageNames | contains([\"@types/node\"])))
            | .allowedVersions) = \"<=${NODE_VERSION:1}\"" \
            renovate.json > tmp.json
          mv tmp.json renovate.json
      - name: Get the Bun version and update .bun-version
        run: |
          BUN_VERSION=$(nix develop --command bun --version)
          echo "$BUN_VERSION" > .bun-version
      - name: Update `wrangler.json` "compatibility_date"
        run: |
          CURRENT_DATE=$(date +%Y-%m-%d)
          jq ".compatibility_date = \"$CURRENT_DATE\"" wrangler.json > tmp.json
          mv tmp.json wrangler.json
      - name: Format JSON files with Biome
        run: |
          BIOME_VERSION=$(nix eval .#meta.package.devDependencies."@biomejs/biome" --raw)
          nix develop --command bunx "@biomejs/biome@$BIOME_VERSION" check --write renovate.json wrangler.json
      - uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: "chore(config): sync config files with flake.lock"
